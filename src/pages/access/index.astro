---
import BaseLayout from "../layouts/BaseLayout.astro";
const SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY;
---

<BaseLayout title="Request access — VDR">
  <main class="container">
    <h1>Request access</h1>
    <p>Доступ надається за запитом. Всі дії логуються. Документи мають версійність.</p>

    {!SITE_KEY ? (
      <p style="color:#b00;">⚠️ PUBLIC_TURNSTILE_SITE_KEY не заданий у Pages env vars.</p>
    ) : (
      <>
        <form id="access-form">
          <label>
            Email
            <input name="email" type="email" required placeholder="name@company.org" />
          </label>

          <label>
            Purpose
            <input name="purpose" type="text" required placeholder="Donor due diligence / partnership / procurement..." />
          </label>

          <div class="cf-turnstile" data-sitekey={SITE_KEY}></div>

          <button type="submit">Submit request</button>
          <p id="msg" role="status" style="margin-top:12px;"></p>
        </form>

        <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

        <script>
          const form = document.getElementById("access-form");
          const msg = document.getElementById("msg");

          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            msg.textContent = "Sending…";

            const fd = new FormData(form);
            const token = fd.get("cf-turnstile-response");

            try {
              const r = await fetch("/api/request-access", {
                method: "POST",
                headers: { "content-type": "application/json" },
                body: JSON.stringify({
                  email: fd.get("email"),
                  purpose: fd.get("purpose"),
                  token
                })
              });

              const data = await r.json().catch(() => ({}));
              if (!r.ok) throw new Error(data?.error || `HTTP ${r.status}`);

              msg.textContent = "✅ Request submitted. We'll get back to you.";
              form.reset();
              if (window.turnstile) window.turnstile.reset();
            } catch (err) {
              msg.textContent = "❌ " + (err?.message || "Failed");
              if (window.turnstile) window.turnstile.reset();
            }
          });
        </script>
      </>
    )}
  </main>

  <style>
    .container { max-width: 760px; margin: 48px auto; padding: 0 16px; }
    h1 { font-size: 40px; margin: 0 0 12px; }
    label { display:block; margin: 14px 0; }
    input { width:100%; padding: 10px 12px; font-size: 16px; }
    button { margin-top: 14px; padding: 10px 14px; font-size: 16px; cursor: pointer; }
  </style>
</BaseLayout>
